<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OmniView</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <link rel="stylesheet" href="monitoring.css" />
  </head>
  <body>
    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title-container">
            <div class="sidebar-title active-screen" id="sidebarTitle">
              MONITORING
            </div>
            <div class="dropdown-arrow">▼</div>
          </div>
          <div class="screen-dropdown" id="screenDropdown">
            <div class="dropdown-item active" data-screen="monitoring">
              <div class="dropdown-icon">📊</div>
              <span>MONITORING</span>
            </div>
            <div class="dropdown-item" data-screen="disaster">
              <div class="dropdown-icon">⚠️</div>
              <span>DISASTER</span>
            </div>
            <div class="dropdown-item" data-screen="analytics">
              <div class="dropdown-icon">📈</div>
              <span>ANALYTICS</span>
            </div>
          </div>
        </div>

        <div class="monitoring-section">
          <div class="monitoring-item active">
            <div class="item-icon">🏢</div>
            <span>Buildings</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">🛣️</div>
            <span>Roads</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">💧</div>
            <span>Water Bodies</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">🚢</div>
            <span>Ships</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">✈️</div>
            <span>Aircraft's</span>
          </div>
        </div>

        <button class="analyze-btn">Analyze</button>
      </div>

      <!-- Map Container -->
      <div class="map-container">
        <!-- Map Tools -->
        <div class="map-tools">
          <button class="tool-btn">✏️</button>
          <button class="tool-btn">⬜</button>
          <button class="tool-btn">✋</button>
          <button class="tool-btn">📏</button>
        </div>

        <!-- Search -->
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Search" />
          <div class="search-icon">🔍</div>
        </div>

        <!-- Layer Switch Buttons -->
        <div class="map-layer-controls">
          <button id="defaultLayerBtn" class="layer-btn active">Default</button>
          <button id="satelliteLayerBtn" class="layer-btn">Satellite</button>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Coordinates -->
        <div class="coordinates" id="coordinates">--- ---° N, --- ---° E</div>

        <!-- Bottom Panel -->
        <div class="bottom-panel">
          <div class="panel-header">
            <div class="panel-title">Logs</div>
            <button class="expand-btn">Expand ▲</button>
          </div>
          <div class="logs-content">
            <div class="log-warning">Warning: No area slected for analysis</div>
            <div class="log-warning">
              <!-- Warning: Can't fetch data for selected area -->
            </div>
            <div class="log-error">
              Error: Can't fetch data for selected area
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Closing tag for main-container -->
    <script src="monitoring.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
      // === Base Layers ===
      const defaultLayer = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { attribution: "© OpenStreetMap contributors", noWrap: true }
      );

      const satelliteLayer = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "Tiles © Esri" }
      );

      // === Map Initialization ===
      const map = L.map("map", {
        center: [20.5937, 78.9629],
        zoom: 5,
        layers: [defaultLayer], // Default layer on load
        minZoom: 3,
        maxZoom: 18,
        maxBounds: [
          [-90, -180],
          [90, 180],
        ],
        maxBoundsViscosity: 1.0,
      });

      // === Markers ===
      const cities = [
        { name: "Pune", coords: [18.5204, 73.8567] },
      ];
      cities.forEach((city) => {
        L.marker(city.coords).addTo(map).bindPopup(city.name);
      });

      // Update coordinates on mouse move
      map.on("mousemove", function (e) {
        document.getElementById("coordinates").textContent =
          `${e.latlng.lat.toFixed(4)}° N, ${e.latlng.lng.toFixed(4)}° E`;
      });

      // Sidebar interactions
      document.querySelectorAll(".monitoring-item").forEach((item) => {
        item.addEventListener("click", function () {
          document
            .querySelectorAll(".monitoring-item")
            .forEach((i) => i.classList.remove("active"));
          this.classList.add("active");
        });
      });

      // Search functionality
      document
        .querySelector(".search-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            const query = this.value;
            console.log("Search for:", query);
          }
        });

      // Analyze button
      document.querySelector(".analyze-btn").addEventListener("click", () => {
        console.log("Starting analysis...");
      });

      // Expand logs
      document
        .querySelector(".expand-btn")
        .addEventListener("click", function () {
          const panel = document.querySelector(".bottom-panel");
          if (panel.style.height === "300px") {
            panel.style.height = "120px";
            this.textContent = "Expand ▲";
          } else {
            panel.style.height = "300px";
            this.textContent = "Collapse ▼";
          }
        });

      let areaSelectMode = false;
      let areaRectangle = null;
      let selectedBounds = null;

      function getSquareBounds(center, sizeMeters = 1000) {
        const halfSizeLat = sizeMeters / 2 / 111000;
        const halfSizeLng =
          sizeMeters / 2 / (111000 * Math.cos((center.lat * Math.PI) / 180));
        return [
          [center.lat - halfSizeLat, center.lng - halfSizeLng],
          [center.lat + halfSizeLat, center.lng + halfSizeLng],
        ];
      }

      document
        .querySelectorAll(".tool-btn")[1]
        .addEventListener("click", () => {
          areaSelectMode = true;
          map.getContainer().style.cursor = "crosshair";
          alert("Click on the map to select the center of a 1km x 1km area.");
        });

      map.on("click", function (e) {
        if (!areaSelectMode) return;

        if (areaRectangle) {
          map.removeLayer(areaRectangle);
          areaRectangle = null;
        }

        const bounds = getSquareBounds(e.latlng, 1000);
        selectedBounds = bounds;
        areaRectangle = L.rectangle(bounds, {
          color: "#00a8e8",
          weight: 2,
        }).addTo(map);

        areaRectangle
          .bindPopup(
            `
    <b>Area Selected</b><br>
    Size: 1km x 1km<br>
    <button id="confirmAreaBtn">Confirm</button>
    <button id="cancelAreaBtn">Cancel</button>
  `
          )
          .openPopup();

        setTimeout(() => {
          document.getElementById("confirmAreaBtn").onclick = () => {
            areaRectangle.closePopup();
            areaSelectMode = false;
            map.getContainer().style.cursor = "";

            fetch("http://localhost:5000/api/area", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ bounds: selectedBounds }),
            })
              .then((res) => res.json())
              .then((data) => {
                areaRectangle
                  .bindPopup(
                    `
          <b>Area Ready</b><br>
          <button id="getSatelliteBtn">Get Satellite Image</button>
          <button id="extractRoadsBtn">Extract Roads</button>
        `
                  )
                  .openPopup();

                setTimeout(() => {
                  document.getElementById("getSatelliteBtn").onclick = () => {
                    fetch("http://localhost:5000/api/satellite-image", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ bounds: selectedBounds }),
                    })
                      .then((res) => res.json())
                      .then((imgData) => {
                        areaRectangle
                          .bindPopup(
                            `<b>Satellite Image</b><br><img src="${imgData.url}" style="width:100%;max-width:300px;">`
                          )
                          .openPopup();
                      });
                  };

                  document.getElementById("extractRoadsBtn").onclick = () => {
                    fetch("http://localhost:5000/api/extract-roads", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ bounds: selectedBounds }),
                    })
                      .then((res) => res.json())
                      .then((roadsData) => {
                        areaRectangle
                          .bindPopup(
                            `<b>Roads Extracted</b><br>${
                              roadsData.summary || "Roads data received."
                            }`
                          )
                          .openPopup();
                      });
                  };
                }, 100);
              });
          };

          document.getElementById("cancelAreaBtn").onclick = () => {
            map.removeLayer(areaRectangle);
            areaRectangle = null;
            areaSelectMode = false;
            map.getContainer().style.cursor = "";
          };
        }, 100);
      });

      // Layer Switch Button Handlers
      document.getElementById("defaultLayerBtn").onclick = function () {
        if (!map.hasLayer(defaultLayer)) {
          map.addLayer(defaultLayer);
        }
        if (map.hasLayer(satelliteLayer)) {
          map.removeLayer(satelliteLayer);
        }
        this.classList.add("active");
        document.getElementById("satelliteLayerBtn").classList.remove("active");
      };

      document.getElementById("satelliteLayerBtn").onclick = function () {
        if (!map.hasLayer(satelliteLayer)) {
          map.addLayer(satelliteLayer);
        }
        if (map.hasLayer(defaultLayer)) {
          map.removeLayer(defaultLayer);
        }
        this.classList.add("active");
        document.getElementById("defaultLayerBtn").classList.remove("active");
      };
    </script>
  </body>
</html>
