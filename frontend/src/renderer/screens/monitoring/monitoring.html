<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OmniView</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    <link rel="stylesheet" href="monitoring.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
  </head>
  <body>
    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title-container">
            <div class="sidebar-title active-screen" id="sidebarTitle">
              MONITORING
            </div>
            <div class="dropdown-arrow">▼</div>
          </div>
          <div class="screen-dropdown" id="screenDropdown">
            <div class="dropdown-item active" data-screen="monitoring">
              <div class="dropdown-icon">📊</div>
              <span>MONITORING</span>
            </div>
            <div class="dropdown-item" data-screen="disaster">
              <div class="dropdown-icon">⚠️</div>
              <span>DISASTER</span>
            </div>
            <div class="dropdown-item" data-screen="analytics">
              <div class="dropdown-icon">📈</div>
              <span>ANALYTICS</span>
            </div>
          </div>
        </div>

        <div class="monitoring-section">
          <div class="monitoring-item active">
            <div class="item-icon">🏢</div>
            <span>Buildings</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">🛣️</div>
            <span>Roads</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">💧</div>
            <span>Water Bodies</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">🚢</div>
            <span>Ships</span>
          </div>
          <div class="monitoring-item">
            <div class="item-icon">✈️</div>
            <span>Aircraft's</span>
          </div>
        </div>

        <button class="analyze-btn">Analyze</button>
      </div>

      <!-- Map Container -->
      <div class="map-container">
        <!-- Map Tools -->
        <div class="map-tools">
          <button class="tool-btn">✏️</button>
          <button class="tool-btn">⬜</button>
          <button class="tool-btn">✋</button>
          <button class="tool-btn">📏</button>
        </div>

        <!-- Search -->
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Search" />
          <div class="search-icon">🔍</div>
        </div>

        <!-- Layer Switch Buttons -->
        <div class="map-layer-controls">
          <button id="defaultLayerBtn" class="layer-btn active">Default</button>
          <button id="satelliteLayerBtn" class="layer-btn">Satellite</button>
        </div>

        <!-- Map -->
        <div id="map"></div>

        <!-- Coordinates -->
        <div class="coordinates" id="coordinates">--- ---° N, --- ---° E</div>

        <!-- Bottom Panel -->
        <div class="bottom-panel">
          <div class="panel-header">
            <div class="panel-title">Logs</div>
            <button class="expand-btn">Expand ▲</button>
          </div>
          <div class="logs-content">
            <div class="log-warning">Warning: No area slected for analysis</div>
            <div class="log-warning">
              <!-- Warning: Can't fetch data for selected area -->
            </div>
            <div class="log-error">
              Error: Can't fetch data for selected area
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Closing tag for main-container -->
    <script src="monitoring.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
      // === Base Layers ===
      const defaultLayer = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { attribution: "© OpenStreetMap contributors", noWrap: true }
      );

      const satelliteLayer = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "Tiles © Esri" }
      );

      // === Map Initialization ===
      const map = L.map("map", {
        center: [20.5937, 78.9629],
        zoom: 5,
        layers: [defaultLayer], // Default layer on load
        minZoom: 3,
        maxZoom: 18,
        maxBounds: [
          [-90, -180],
          [90, 180],
        ],
        maxBoundsViscosity: 1.0,
      });

      // === Feature Layers ===
      const featureLayers = {
        buildings: L.layerGroup().addTo(map),
        roads: L.layerGroup().addTo(map),
        water: L.layerGroup().addTo(map),
        ships: L.layerGroup().addTo(map),
        aircraft: L.layerGroup().addTo(map),
      };

      // Track active features
      let activeFeature = "buildings";
      let areaSelectMode = false;
      let areaRectangle = null;
      let selectedBounds = null;

      // === Markers ===
      const cities = [{ name: "Pune", coords: [18.5204, 73.8567] }];
      cities.forEach((city) => {
        L.marker(city.coords).addTo(map).bindPopup(city.name);
      });

      // Update coordinates on mouse move
      map.on("mousemove", function (e) {
        document.getElementById("coordinates").textContent =
          `${e.latlng.lat.toFixed(4)}° N, ${e.latlng.lng.toFixed(4)}° E`;
      });

      // Sidebar interactions
      document.querySelectorAll(".monitoring-item").forEach((item, index) => {
        item.addEventListener("click", function () {
          // Remove active class from all items
          document
            .querySelectorAll(".monitoring-item")
            .forEach((i) => i.classList.remove("active"));
          this.classList.add("active");

          // Clear all layers and stop any running processes
          Object.values(featureLayers).forEach((layer) => layer.clearLayers());
          if (updateFlightsInterval) {
            clearInterval(updateFlightsInterval);
            updateFlightsInterval = null;
          }

          // Reset area selection mode
          areaSelectMode = false;
          if (areaRectangle) {
            map.removeLayer(areaRectangle);
            areaRectangle = null;
          }
          map.getContainer().style.cursor = "";

          // Handle specific feature activation
          switch (index) {
            case 0: // Buildings
              activeFeature = "buildings";
              // Add your buildings feature code here
              break;

            case 1: // Roads
              activeFeature = "roads";
              areaSelectMode = true;
              map.getContainer().style.cursor = "crosshair";
              alert(
                "Click on the map to select the center of a 1km x 1km area for road extraction."
              );
              break;

            case 2: // Water Bodies
              activeFeature = "water";
              // Add your water bodies feature code here
              break;

            case 3: // Ships
              activeFeature = "ships";
              // Add your ships feature code here
              break;

            case 4: // Aircraft
              activeFeature = "aircraft";
              // Clear any existing interval
              if (updateFlightsInterval) {
                clearInterval(updateFlightsInterval);
              }
              // Start fresh tracking
              updateFlights();
              updateFlightsInterval = setInterval(updateFlights, 30000);
              break;
          }
        });
      });

      // Search functionality
      document
        .querySelector(".search-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            const query = this.value;
            console.log("Search for:", query);
          }
        });

      // Analyze button
      document.querySelector(".analyze-btn").addEventListener("click", () => {
        console.log("Starting analysis...");
      });

      // Expand logs
      document
        .querySelector(".expand-btn")
        .addEventListener("click", function () {
          const panel = document.querySelector(".bottom-panel");
          if (panel.style.height === "300px") {
            panel.style.height = "120px";
            this.textContent = "Expand ▲";
          } else {
            panel.style.height = "300px";
            this.textContent = "Collapse ▼";
          }
        });

      function getSquareBounds(center, sizeMeters = 500) {
        const halfSizeLat = sizeMeters / 2 / 111000; // Convert meters to degrees (approximately)
        const halfSizeLng =
          sizeMeters / 2 / (111000 * Math.cos((center.lat * Math.PI) / 180));
        return [
          [center.lat - halfSizeLat, center.lng - halfSizeLng],
          [center.lat + halfSizeLat, center.lng + halfSizeLng],
        ];
      }

      document
        .querySelectorAll(".monitoring-item")[1]
        .addEventListener("click", () => {
          // Enable area selection for roads tab
          areaSelectMode = true;
          map.getContainer().style.cursor = "crosshair";
          alert(
            "Click on the map to select the center of a 1km x 1km area for road extraction."
          );
        });

      // Replace the existing map click handler
      map.on("click", function (e) {
        if (!areaSelectMode) return;

        if (areaRectangle) {
          featureLayers.roads.removeLayer(areaRectangle);
          areaRectangle = null;
        }

        // Remove existing control if present
        const existingControl = document.querySelector('.area-control');
        if (existingControl) {
          existingControl.remove();
        }

        // Initial bounds with 500m default
        const bounds = getSquareBounds(e.latlng, 500);
        selectedBounds = bounds;
        areaRectangle = L.rectangle(bounds, {
          color: "#00a8e8",
          weight: 2,
        }).addTo(featureLayers.roads);

        // Create custom control
        const controlDiv = document.createElement('div');
        controlDiv.className = 'area-control';
        controlDiv.innerHTML = `
          <b>Area Selected</b><br>
          <div style="margin-bottom: 10px;">
            <label for="areaSize">Area Size (meters):</label>
            <input type="number" id="areaSize" value="500" min="100" max="2000" step="100" style="width: 80px;">
          </div>
          <button id="extractRoadsBtn">Extract Roads</button>
          <button id="cancelAreaBtn">Cancel</button>
        `;

        // Add control to the map container
        document.querySelector('.map-container').appendChild(controlDiv);

        // Add size change handler
        const sizeInput = document.getElementById("areaSize");
        if (sizeInput) {
          sizeInput.onchange = () => {
            const newSize = parseInt(sizeInput.value);
            if (newSize >= 100 && newSize <= 2000) {
              const newBounds = getSquareBounds(e.latlng, newSize);
              selectedBounds = newBounds;
              areaRectangle.setBounds(newBounds);
            }
          };
        }

        // Extract Roads button handler
        const extractBtn = document.getElementById("extractRoadsBtn");
        if (extractBtn) {
          extractBtn.onclick = async () => {
            areaSelectMode = false;
            map.getContainer().style.cursor = "";
            map.fitBounds(selectedBounds);

            // Remove the control before taking screenshot
            controlDiv.style.display = 'none';

            setTimeout(async () => {
              const mapDiv = document.getElementById("map");
              const canvas = await html2canvas(mapDiv, {
                useCORS: true,
                backgroundColor: null,
              });

              // Get pixel coordinates for bounds
              const nw = map.latLngToContainerPoint(selectedBounds[0]);
              const se = map.latLngToContainerPoint(selectedBounds[1]);

              // Calculate crop dimensions
              const x = Math.min(nw.x, se.x);
              const y = Math.min(nw.y, se.y);
              const width = Math.abs(se.x - nw.x);
              const height = Math.abs(se.y - nw.y);

              // Crop the canvas
              const croppedCanvas = document.createElement("canvas");
              croppedCanvas.width = width;
              croppedCanvas.height = height;
              const ctx = croppedCanvas.getContext("2d");
              ctx.drawImage(canvas, x, y, width, height, 0, 0, width, height);

              const imageBase64 = croppedCanvas.toDataURL("image/png");

              // Show preview of cropped area
              areaRectangle
                .bindPopup(
                  `<b>Processing Area</b><br>
          <div>
            <strong>Selected Area Image:</strong><br>
            <img src="${imageBase64}" style="width:100%;max-width:300px;"><br>
            <div style="text-align:center">Processing...</div>
          </div>`
                )
                .openPopup();

              fetch("http://localhost:5000/api/road-detection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image_base64: imageBase64 }),
              })
                .then(async (res) => {
                  const body = await res.json().catch(() => ({}));
                  if (!res.ok) {
                    areaRectangle
                      .bindPopup(`<b>Error</b><br>${body.error || "Server error"}`)
                      .openPopup();
                    return;
                  }
                  const probMask = body.probability_mask;
                  areaRectangle
                    .bindPopup(
                      `<b>Road Detection Result</b><br>
              <div>
                <strong>Input Image:</strong><br>
                <img src="${imageBase64}" style="width:100%;max-width:300px;"><br>
                <strong>Road Mask:</strong><br>
                <img src="${probMask}" style="width:100%;max-width:300px;"><br>
                <button id="downloadInputBtn">Download Input</button>
                <button id="downloadMaskBtn">Download Mask</button>
              </div>`
                    )
                    .openPopup();

                  setTimeout(() => {
                    // Download Input Image
                    const downloadInputBtn = document.getElementById("downloadInputBtn");
                    if (downloadInputBtn) {
                      downloadInputBtn.onclick = () => {
                        const link = document.createElement("a");
                        link.href = imageBase64;
                        link.download = "road_input.png";
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                      };
                    }

                    // Download Mask Image
                    const downloadMaskBtn = document.getElementById("downloadMaskBtn");
                    if (downloadMaskBtn) {
                      downloadMaskBtn.onclick = () => {
                        const link = document.createElement("a");
                        link.href = probMask;
                        link.download = "road_mask.png";
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                      };
                    }
                  }, 150);
                })
                .catch((err) => {
                  areaRectangle
                    .bindPopup("Error extracting roads (network/server).")
                    .openPopup();
                });
            }, 1000);
          };
        }

        // Cancel button handler
        const cancelBtn = document.getElementById("cancelAreaBtn");
        if (cancelBtn) {
          cancelBtn.onclick = () => {
            map.removeLayer(areaRectangle);
            areaRectangle = null;
            areaSelectMode = false;
            map.getContainer().style.cursor = "";
            controlDiv.remove();
          };
        }
      });

      // Layer Switch Button Handlers
      document.getElementById("defaultLayerBtn").onclick = function () {
        if (!map.hasLayer(defaultLayer)) {
          map.addLayer(defaultLayer);
        }
        if (map.hasLayer(satelliteLayer)) {
          map.removeLayer(satelliteLayer);
        }
        this.classList.add("active");
        document.getElementById("satelliteLayerBtn").classList.remove("active");
      };

      document.getElementById("satelliteLayerBtn").onclick = function () {
        if (!map.hasLayer(satelliteLayer)) {
          map.addLayer(satelliteLayer);
        }
        if (map.hasLayer(defaultLayer)) {
          map.removeLayer(defaultLayer);
        }
        this.classList.add("active");
        document.getElementById("defaultLayerBtn").classList.remove("active");
      };

      // === Aircraft plotting ===
      // let aircraftLayer = L.layerGroup().addTo(map);
      let updateFlightsInterval;

      // Create plane icon once
      const planeIcon = L.icon({
        iconUrl: "../../../assets/airplane.png",
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16],
      });

      async function updateFlights() {
        try {
          const res = await fetch("http://localhost:5000/api/flights");
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

          const data = await res.json();

          // Only update if we're on the aircraft tab
          if (activeFeature === "aircraft") {
            featureLayers.aircraft.clearLayers(); // Clear the correct layer

            if (!data.states || !Array.isArray(data.states)) {
              console.warn("No flight data available or invalid format");
              return;
            }

            const maxPlanes = 1000;
            const planes = data.states.slice(0, maxPlanes);

            function createRotatedPlaneIcon(heading) {
              const iconHtml = `
          <div style="
            width: 32px; 
            height: 32px; 
            transform: rotate(${heading}deg);
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <img src="../../../assets/airplane.png" style="width: 32px; height: 32px;" alt="plane" />
          </div>
        `;

              return L.divIcon({
                html: iconHtml,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16],
                className: "custom-plane-icon",
              });
            }

            planes.forEach((state) => {
              const lat = state[6];
              const lon = state[5];
              const callsign = state[1]?.trim() || "Unknown";
              const altitude = Math.round((state[7] || 0) * 3.28084);
              const velocity = Math.round((state[9] || 0) * 2.236936);
              const heading = state[10];

              if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                if (heading !== null && !isNaN(heading)) {
                  const rotatedIcon = createRotatedPlaneIcon(heading);
                  const marker = L.marker([lat, lon], { icon: rotatedIcon });

                  marker.bindPopup(`
              <b>Flight: ${callsign}</b><br>
              Altitude: ${altitude} ft<br>
              lat: ${lat.toFixed(4)}°, lon: ${lon.toFixed(4)}°<br>
              Speed: ${velocity} mph<br>
              Heading: ${heading}°
            `);

                  marker.addTo(featureLayers.aircraft); // Add to the correct layer
                }
              }
            });

            console.log(`Updated ${planes.length} aircraft positions`);
          }
        } catch (err) {
          console.error("Failed to fetch aircraft data:", err);
        }
      }
    </script>
  </body>
</html>
